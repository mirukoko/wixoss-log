<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WIXOSS MATCH LOGï¼ˆé–²è¦§å°‚ç”¨ï¼‰</title>

<style>
body{
  margin:0;padding:16px;
  font-family:system-ui,sans-serif;
  background:#0a0c14;color:#e3e7ff;
}
h1{
  margin:0 0 1em;font-size:1.6rem;text-align:center;
  text-shadow:0 0 6px rgba(66,165,245,.8);
}

/* â–¼ èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ */
#loadJsonBtn{
  display:block;width:100%;padding:12px;
  background:#1e88e5;color:#fff;border:none;
  border-radius:8px;font-size:1rem;margin-bottom:16px;
}

/* â–¼ ãƒ•ã‚£ãƒ«ã‚¿ */
.frame{
  background:#141824;border:1px solid rgba(192,198,216,.4);
  border-radius:10px;padding:12px;margin-bottom:16px;
}
.frame-title{
  font-size:1rem;margin-bottom:8px;color:#42a5f5;
}

/* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¹ãƒãƒ›æœ€é©åŒ–ï¼‰ */
.table-wrapper{
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}

/* â† ãƒ†ãƒ¼ãƒ–ãƒ«å¹…ã‚’å›ºå®šã—ã¦æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç™ºç”Ÿã•ã›ã‚‹ */
table{
  width:100%;
  border-collapse:collapse;
  font-size:.85rem;
  min-width: 900px;
}

th,td{
  border:1px solid rgba(192,198,216,.3);
  padding:6px 8px;vertical-align:top;
}
th{
  background:#283a5a;font-size:.75rem;
}
.lose-row{background:#1b2230;}
.note-divider{
  border-top:1px dashed rgba(192,198,216,.5);
  margin:4px 0;
}
.note-reflect{color:#E6D37A;}

/* å‚™è€ƒæ¬„ã‚’åºƒã‚ã« */
td:nth-child(7){
  min-width: 260px;
}

/* â–¼ å‚™è€ƒé–‹é–‰ç”¨ */
.note-toggle{
  cursor:pointer;
  color:#E6D37A;
  user-select:none;
}

/* â–¼ å‚™è€ƒæ¬„ã®æ¨ªå¹…ã‚’ç‹­ãã™ã‚‹ï¼ˆä»Šå›ã®æ”¹å–„ç‚¹ï¼‰ */
.note-content{
  display:none;
  margin-top:6px;
  max-width:220px;     /* â† æ¨ªå¹…ã‚’ç‹­ãã™ã‚‹ */
  word-break:break-word;
}

/* â–¼ ã‚°ãƒ©ãƒ• */
.charts-container{
  display:flex;flex-wrap:wrap;gap:12px;margin-top:12px;
}
.chart-box{
  background:#181c2a;border:1px solid rgba(192,198,216,.4);
  border-radius:8px;padding:8px;width:160px;text-align:center;
}
.chart-title{font-size:.75rem;margin-bottom:4px;color:#9fa6c5;}
.chart-note{font-size:.7rem;margin-top:4px;color:#9fa6c5;}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1>WIXOSS MATCH LOGï¼ˆé–²è¦§å°‚ç”¨ï¼‰</h1>

<button id="loadJsonBtn">JSON ã‚’èª­ã¿è¾¼ã‚€ï¼ˆOneDrive ã‹ã‚‰é¸æŠï¼‰</button>

<!-- â–¼ FILTER -->
<div class="frame">
  <div class="frame-title">FILTER</div>
  <select id="filterLrig" style="width:100%;padding:8px;border-radius:6px;">
    <option value="">ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</option>
  </select>

  <div class="charts-container">
    <div class="chart-box">
      <div class="chart-title">åˆè¨ˆ å‹ç‡</div>
      <canvas id="totalChart"></canvas>
      <div class="chart-note" id="totalSummary"></div>
    </div>
    <div class="chart-box">
      <div class="chart-title">å…ˆè¡Œ å‹ç‡</div>
      <canvas id="firstChart"></canvas>
      <div class="chart-note" id="firstSummary"></div>
    </div>
    <div class="chart-box">
      <div class="chart-title">å¾Œæ”» å‹ç‡</div>
      <canvas id="secondChart"></canvas>
      <div class="chart-note" id="secondSummary"></div>
    </div>
  </div>
</div>

<!-- â–¼ MATCH LOG -->
<div class="frame">
  <div class="frame-title">MATCH LOG</div>
  <div class="table-wrapper">
    <table id="matchTable">
      <thead>
        <tr>
          <th>æ—¥ä»˜</th><th>å ´æ‰€</th><th>è‡ªåˆ†</th><th>ç›¸æ‰‹</th>
          <th>å…ˆå¾Œ</th><th>å‹æ•—</th><th>å‚™è€ƒ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let matches=[];
let firstChart=null, secondChart=null, totalChart=null;

/* â–¼ JSON èª­ã¿è¾¼ã¿ï¼ˆSafariå¯¾å¿œç‰ˆï¼‰ */
document.getElementById("loadJsonBtn").addEventListener("click", ()=>{
  const input=document.createElement("input");
  input.type="file";
  input.accept=".json,application/json";
  input.style.display="none";

  document.body.appendChild(input);

  input.addEventListener("change", async e=>{
    const file=e.target.files[0];
    if(!file){
      document.body.removeChild(input);
      return;
    }

    const text=await file.text();
    matches=JSON.parse(text);

    renderFilterOptions();
    renderTable();

    document.body.removeChild(input);
  });

  input.click();
});

/* â–¼ ãƒ«ãƒªã‚°åã®æ‹¬å¼§ã‚’é™¤å» */
function normalizeLrig(name){ return name.replace(/ï¼ˆ.*?ï¼‰/g,""); }

/* â–¼ ãƒ•ã‚£ãƒ«ã‚¿æ›´æ–° */
function renderFilterOptions(){
  const set=new Set(matches.map(m=>normalizeLrig(m.myLrig)).filter(Boolean));
  const sel=document.getElementById("filterLrig");
  sel.innerHTML='<option value="">ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</option>';
  set.forEach(l=>{
    const o=document.createElement("option");
    o.value=l; o.textContent=l;
    sel.appendChild(o);
  });
}

/* â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«æç”» */
function renderTable(filter=""){
  const tb=document.querySelector("#matchTable tbody");
  tb.innerHTML="";

  matches.sort((a,b)=>new Date(b.date)-new Date(a.date));

  matches.forEach(m=>{
    if(filter && normalizeLrig(m.myLrig)!==filter) return;

    const tr=document.createElement("tr");
    if(m.result==="è² ã‘") tr.classList.add("lose-row");

    tr.innerHTML=`
      <td>${m.date}</td>
      <td>${m.place}</td>
      <td>${m.myLrig}</td>
      <td>${m.oppLrig}</td>
      <td>${m.order}</td>
      <td>${m.result}</td>
      <td>
        <div class="note-toggle">â–¶ å‚™è€ƒã‚’é–‹ã</div>
        <div class="note-content">
          <div>ğŸ“ ${m.noteResult || ""}</div>
          <div class="note-divider"></div>
          <div class="note-reflect">ğŸ’¡ ${m.noteReflect || ""}</div>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });

  /* â–¼ å‚™è€ƒã®é–‹é–‰ã‚¤ãƒ™ãƒ³ãƒˆ */
  tb.querySelectorAll(".note-toggle").forEach(toggle=>{
    toggle.addEventListener("click",()=>{
      const content=toggle.nextElementSibling;
      const isOpen=content.style.display==="block";

      content.style.display=isOpen?"none":"block";
      toggle.textContent=isOpen?"â–¶ å‚™è€ƒã‚’é–‹ã":"â–¼ å‚™è€ƒã‚’é–‰ã˜ã‚‹";
    });
  });

  updateCharts(filter);
}

/* â–¼ å‹ç‡ã‚°ãƒ©ãƒ•æ›´æ–° */
function updateCharts(filter=""){
  let fw=0,fl=0,sw=0,sl=0;

  matches.forEach(m=>{
    if(filter && normalizeLrig(m.myLrig)!==filter) return;

    if(m.order==="å…ˆè¡Œ"){
      if(m.result==="å‹ã¡") fw++; else fl++;
    } else {
      if(m.result==="å‹ã¡") sw++; else sl++;
    }
  });

  const tw=fw+sw, tl=fl+sl;
  const red="#e53935", blue="#1e88e5";

  if(firstChart) firstChart.destroy();
  if(secondChart) secondChart.destroy();
  if(totalChart) totalChart.destroy();

  totalChart=new Chart(document.getElementById("totalChart"),{
    type:"doughnut",
    data:{labels:["å‹ã¡","è² ã‘"],datasets:[{data:[tw,tl],backgroundColor:[red,blue]}]}
  });

  firstChart=new Chart(document.getElementById("firstChart"),{
    type:"doughnut",
    data:{labels:["å‹ã¡","è² ã‘"],datasets:[{data:[fw,fl],backgroundColor:[red,blue]}]}
  });

  secondChart=new Chart(document.getElementById("secondChart"),{
    type:"doughnut",
    data:{labels:["å‹ã¡","è² ã‘"],datasets:[{data:[sw,sl],backgroundColor:[red,blue]}]}
  });

  document.getElementById("totalSummary").textContent =
    tw+tl ? `å‹ç‡ ${Math.round(tw/(tw+tl)*100)}%` : "ãƒ‡ãƒ¼ã‚¿ãªã—";

  document.getElementById("firstSummary").textContent =
    fw+fl ? `å‹ç‡ ${Math.round(fw/(fw+fl)*100)}%` : "ãƒ‡ãƒ¼ã‚¿ãªã—";

  document.getElementById("secondSummary").textContent =
    sw+sl ? `å‹ç‡ ${Math.round(sw/(sw+sl)*100)}%` : "ãƒ‡ãƒ¼ã‚¿ãªã—";
}

/* â–¼ ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´ */
document.getElementById("filterLrig").addEventListener("change",e=>{
  renderTable(e.target.value);
});
</script>

</body>
</html>
